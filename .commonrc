#!/usr/bin/env bash
# vim: set syn=bash ft=bash:

alias whichp='/usr/bin/env which'
export HISTSIZE=5000
export HISTFILESIZE=10000

if [ -z "$FZF_STARTUP_LOCATION" ]; then
    find_fzf() {
        readlink -f "$(whichp fzf 2>/dev/null)" | \
            sed 's#/[^/]*/[^/]*$##'
    }
    export FZF_STARTUP_LOCATION="$(find_fzf)"
fi

conditional_source() {
    [ -f "$1" ] && source "$1"
}

conditional_source "/etc/.commonrc"

#aliases
conditional_source "/etc/.aliasrc"
conditional_source "$HOME/.aliasrc"
conditional_source "$HOME/.local/.aliasrc"

#functions
conditional_source "/etc/.funcrc"
conditional_source "$HOME/.funcrc"
conditional_source "$HOME/.local/.funcrc"

#common variables

conditional_source "$HOME/.local/.commonrc"

if [ -z "$__VARRC_ETC_SOURCED" ]; then
    conditional_source "/etc/.varrc"
    export __VARRC_ETC_SOURCED=1
fi

conditional_source "$HOME/.varrc"

if [ "$__VARRC_LOCAL_SOURCED" != "$UID" ]; then
    conditional_source "$HOME/.local/.varrc"
    export __VARRC_LOCAL_SOURCED="$UID"
fi

if [ -z "$SSH_AGENT_TIME" ]; then
    export SSH_AGENT_TIME="90m"
fi

run_ssh_agent () {
    local AGENT_ENV="$XDG_RUNTIME_DIR/ssh-agent.env"

    if ! [ -f "$AGENT_ENV" ]; then
        ssh-agent -t "$SSH_AGENT_TIME" > "$AGENT_ENV"
    fi

    if [ ! -f "$SSH_AUTH_SOCK" ]; then
        source "$XDG_RUNTIME_DIR/ssh-agent.env" >/dev/null
    fi
}

# Should be good
if ! pgrep -u "$USER" ssh-agent >/dev/null 2>/dev/null
then
    run_ssh_agent
fi

if [ "$__NIX_SOURCED" != "$UID" ]; then
    conditional_source "$HOME/.nix-profile/etc/profile.d/nix.sh"
    export __NIX_SOURCED="$UID"
fi

export __HM_SESS_VARS_SOURCED= # fuck this
if [ "$__HM_SESS_SOURCED" != "$UID" ]; then
    conditional_source "$HOME/.nix-profile/etc/profile.d/hm-session-vars.sh"
    export __HM_SESS_SOURCED="$UID"
fi

# Compatibility between tmux and direnv
if [ -n "$TMUX" ] && [ -n "$DIRENV_DIR" ]; then
    # unset env vars starting with DIRENV_
    if [ -n "$ZSH_NAME" ]; then
        unset ${$(typeset -m "DIRENV_*")%%=*}
    else
        unset "${!DIRENV_@}"
    fi
fi
