#!/usr/bin/env bash

# helpers {{{

has_exe() {
    command -v "$1" >/dev/null
}

source_if_exists() {
    [ -r "$1" ] && source "$1"
}

# Because this is not obvious sometimes (zsh)
alias whichp='/usr/bin/env which'

# }}}

# settings {{{

export HISTSIZE=5000
export HISTFILESIZE=100000

stty -ixon 2>/dev/null

#  }}}

# sourcing {{{

source_if_exists "/etc/.commonrc"

#aliases
source_if_exists "/etc/.aliasrc"
source_if_exists "$HOME/.aliasrc"

#functions
source_if_exists "/etc/.funcrc"
source_if_exists "$HOME/.funcrc"

# to stop duplication of entries in some variables
if [ -z "$__VARRC_ETC_SOURCED" ]; then
    source_if_exists "/etc/.varrc"
    export __VARRC_ETC_SOURCED=1
fi

source_if_exists "$HOME/.varrc"

# same thing
if [ "$__VARRC_LOCAL_SOURCED" != "$UID" ]; then
    source_if_exists "$HOME/.local/.varrc"
    export __VARRC_LOCAL_SOURCED="$UID"
fi

# }}}

# ssh agent {{{

if [ -z "$SSH_AGENT_TIME" ]; then
    export SSH_AGENT_TIME="90m"
fi
if [ -z "$SSH_AGENT_ENV" ]; then
    mkdir -p "$HOME/.ssh"
    export SSH_AGENT_ENV="$HOME/.ssh/agent.env"
fi

run_ssh_agent() {
    [ -S "$SSH_AUTH_SOCK" ] && return

    if [ -z "$SSH_AUTH_SOCK" ]; then
        if [ -n "$XDG_RUNTIME_DIR" ]; then
            SSH_AUTH_SOCK="$XDG_RUNTIME_DIR"
        elif [ -d "/run/user/$UID" ]; then
            SSH_AUTH_SOCK="/run/user/$UID"
        else
            SSH_AUTH_SOCK="$HOME/.ssh"
        fi
        export SSH_AUTH_SOCK="$SSH_AUTH_SOCK/ssh-agent.socket"
    fi

    if [ -z "$SSH_AGENT_TIME" ]; then
        ssh-agent -a "$SSH_AUTH_SOCK" -t "$SSH_AGENT_TIME" > "$SSH_AGENT_ENV"
    else
        ssh-agent -a "$SSH_AUTH_SOCK" > "$SSH_AGENT_ENV"
    fi
}

run_ssh_agent

# }}}

# nix {{{

# they screwed up
if [ "$__NIX_SOURCED" != "$UID" ]; then
    source_if_exists "$HOME/.nix-profile/etc/profile.d/nix.sh"
    export __NIX_SOURCED="$UID"
fi

# they fucked up
export __HM_SESS_VARS_SOURCED= # fuck this
if [ "$__HM_SESS_SOURCED" != "$UID" ]; then
    source_if_exists "$HOME/.nix-profile/etc/profile.d/hm-session-vars.sh"
    export __HM_SESS_SOURCED="$UID"
fi

# }}}

# locals {{{

source_if_exists "$HOME/.local/.commonrc"
source_if_exists "$HOME/.local/.aliasrc"
source_if_exists "$HOME/.local/.funcrc"

#  }}}
