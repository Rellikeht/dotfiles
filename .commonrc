#!/usr/bin/env bash

# helpers {{{

has_exe() {
    command -v "$1" >/dev/null
}

source_if_exists() {
    [ -r "$1" ] && source "$1"
}

eval_if_exists() {
    [ -r "$1" ] && . "$1"
}

# Because this is not obvious sometimes (zsh)
alias whichp='/usr/bin/env which'

# }}}

# settings {{{

export HISTSIZE=5000
export HISTFILESIZE=100000

stty -ixon 2>/dev/null

#  }}}

# sourcing {{{

source_if_exists "/etc/.commonrc"

#aliases
source_if_exists "/etc/.aliasrc"
source_if_exists "$HOME/.aliasrc"

#functions
source_if_exists "/etc/.funcrc"
source_if_exists "$HOME/.funcrc"

# to stop duplication of entries in some variables
if [ -z "$__VARRC_ETC_SOURCED" ]; then
    source_if_exists "/etc/.varrc"
    export __VARRC_ETC_SOURCED=1
fi

source_if_exists "$HOME/.varrc"

# same thing
if [ "$__VARRC_LOCAL_SOURCED" != "$UID" ]; then
    source_if_exists "$HOME/.local/.varrc"
    export __VARRC_LOCAL_SOURCED="$UID"
fi

# }}}

# ssh agent {{{

if [ -z "$SSH_AGENT_TIME" ]; then
    export SSH_AGENT_TIME="90m"
fi

# Yeah, because this is hard, especially when having
# one config for multiple environments
run_ssh_agent() {
    local DIR
    if [ -n "$XDG_RUNTIME_DIR" ]; then
        DIR="$XDG_RUNTIME_DIR"
    else
        DIR="/run/user/$UID"
        if ! [ -d "/run/user/$UID" ]; then
            return 1
        fi
    fi
    local AGENT_ENV="$DIR/ssh-agent.env"

    if ! [ -f "$AGENT_ENV" ]; then
        ssh-agent -t "$SSH_AGENT_TIME" >"$AGENT_ENV"
    fi

    if [ ! -f "$SSH_AUTH_SOCK" ]; then
        source "$AGENT_ENV" >/dev/null
    fi
}

# Should be good
if ! pgrep -u "$USER" ssh-agent &>/dev/null; then
    run_ssh_agent
fi

# }}}

# nix {{{

# they screwed up
if [ "$__NIX_SOURCED" != "$UID" ]; then
    source_if_exists "$HOME/.nix-profile/etc/profile.d/nix.sh"
    export __NIX_SOURCED="$UID"
fi

# they fucked up
export __HM_SESS_VARS_SOURCED= # fuck this
if [ "$__HM_SESS_SOURCED" != "$UID" ]; then
    source_if_exists "$HOME/.nix-profile/etc/profile.d/hm-session-vars.sh"
    export __HM_SESS_SOURCED="$UID"
fi

# }}}

# locals {{{

source_if_exists "$HOME/.local/.commonrc"
source_if_exists "$HOME/.local/.aliasrc"
source_if_exists "$HOME/.local/.funcrc"

#  }}}
